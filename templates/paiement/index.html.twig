{% extends 'base.html.twig' %}

{% block title %}Hello PaiementController!{% endblock %}

{% block body %}
<style>
    .example-wrapper { margin: 1em auto; max-width: 800px; width: 95%; font: 18px/1.5 sans-serif; }
    .example-wrapper code { background: #F5F5F5; padding: 2px 6px; }
</style>

{% if not data %}
<div class="example-wrapper">
    <h1>{{ controller_name }}</h1>

    <p id="paylabel">Vous etes sur le point d'éffectuer un paiement:</p>

    {{ form(paiementForm) }}
</div>
<script>
var datain =  {{data|json_encode()|raw}};
var jsonform = JSON.stringify(datain);
var myParam = location.search.split('p=')[1]
var decrypted = CryptoJS.AES.decrypt(myParam, "Secret Passphrase");
var idabonement = decrypted.toString(CryptoJS.enc.Utf8);
var itemabbo=[];

if (typeof(Storage) !== "undefined") {
  // Store
 // localStorage.setItem("lastname", "Smith");
  // Retrieve
  itemabbo=localStorage.getItem(idabonement);
  
} else {
  //document.getElementById("result").innerHTML = "Sorry, your browser does not support Web Storage...";
}
itemabbo = JSON.parse(itemabbo);
console.log(itemabbo["priapayer"]);
$("#paylabel").append("<p> Prix à payer : "+itemabbo["priapayer"]+" Euros</p>");
</script>
{% else %}
<script>
var datain =  {{data|json_encode()|raw}};
var jsonform = JSON.stringify(datain);
var myParam = location.search.split('p=')[1]
var decrypted = CryptoJS.AES.decrypt(myParam, "Secret Passphrase");
var idabonement = decrypted.toString(CryptoJS.enc.Utf8);
var itemabbo=[];
console.log(datain['UUID'])
if (typeof(Storage) !== "undefined") {
  // Store
 // localStorage.setItem("lastname", "Smith");
  // Retrieve
  itemabbo=localStorage.getItem(idabonement);
  
} else {
  //document.getElementById("result").innerHTML = "Sorry, your browser does not support Web Storage...";
}
itemabbo = JSON.parse(itemabbo);
var paydata = JSON.stringify({ uuid : datain['UUID'],cid : datain['CID'],cardnumber : datain['CARDNUMBER'],month : datain['MONTH'],year : datain['YEAR'],amount:itemabbo["priapayer"] });
var paydatapath = "api/paiementretour/"+ datain['UUID']+"/"+myParam+"/"+ datain['CARDNUMBER']+"/"+datain['MONTH']+"/"+datain['YEAR']+"/"+itemabbo["priapayer"];
console.log(paydatapath);
console.log(paydata);
 $.ajax(paydatapath, {
    method: "GET",
    contentType: 'application/json',
    processData: false,
    //data: paydata
    })
    
    .then(
    function success(data) {
   
        alert('modification prise en compte');
       
       
       
       
    }
);   
</script>
{% endif %}
{% endblock %}
